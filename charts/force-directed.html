<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      text {
        font: 10px sans-serif;
      }

      .background {
        fill: none;
        pointer-events: all;
      }

      #chart1 .node {
        stroke: #fff;
        stroke-width: 1.5px;
      }

      #chart1 .link {
        stroke: #999;
        stroke-opacity: 0.6;
        stroke-width: 1.5px;
      }

      .links line {
        stroke: #999;
        stroke-opacity: 0.6;
      }

      .nodes circle {
        stroke: #fff;
        stroke-width: 1.5px;
      }

      text {
        font-family: sans-serif;
        font-size: 10px;
      }
      .chart-tooltip {
        height: auto;
        padding: 6px;
        width: auto;
        border-radius: 10px;
      }

      .btn svg {
        width: 20px;
        height: 20px;
      }
      .bth-position {
        display: flex;
        flex-direction: column;
      }
      .bth-position > * {
        margin-left: 7px;
      }
      #chart1 {
        width: 100%;
        height: calc(100vh - 100px);
      }
      .btn-bottom {
        position: absolute;
        bottom: 19px;
        right: 29px;
        z-index: 20;
      }
      .btn-bottom > * {
        margin-top: 10px;
      }
    </style>
  </head>
  <body onload="loadForChart()">
    <div style="font-size: 12px; display: flex; flex-direction: column; align-items: flex-end; position: fixed; z-index: 20; right:10px">
      <ul style="margin: 0;">
        <li>Zoom in with '+' and Zoom out with '-' buttons</li>
        <li>Reshape button redraw the graph for different perspective</li>
        <li>Click the mouse and hold on particular node to move the graph on the Canvas</li>
      </ul>
    </div>
    <div class="bth-position btn-bottom">
      <button class="btn" title="zoom in" id="zoomIN">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
          <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z"/>
        </svg>
      </button>
      <button class="btn" title="zoom out" id="zoonOut">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M3 10a.75.75 0 01.75-.75h10.5a.75.75 0 010 1.5H3.75A.75.75 0 013 10z" clip-rule="evenodd"/>
        </svg>
      </button>
      <button class="btn" onclick="redraw()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 19.5C16.1421 19.5 19.5 16.1421 19.5 12C19.5 7.85786 16.1421 4.5 12 4.5C7.85786 4.5 4.5 7.85786 4.5 12C4.5 16.1421 7.85786 19.5 12 19.5Z" stroke="#19233C" stroke-width="1.25" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M19.5 12H16.5" stroke="#19233C" stroke-width="1.25" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M7.5 12H4.5" stroke="#19233C" stroke-width="1.25" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M12 7.5V4.5" stroke="#19233C" stroke-width="1.25" stroke-linecap="round" stroke-linejoin="round" />
          <path d="M12 19.5V16.5" stroke="#19233C" stroke-width="1.25" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
    <div
      class="position-relative"
      style="
        display: flex;
        justify-content: center;
        flex-direction: column;
        align-items: center;
      "
    >
      <div class="chart-tooltip" id="tooltip">Tootltip</div>
      <div id="chart1"/>
    </div>
    <script src="https://d3js.org/d3.v4.min.js" charset="utf-8"></script>
    <script src="../design/js/fisheye.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"
      integrity="sha512-WFN04846sdKMIP5LKNphMaWzU7YpMyCU245etK3g/2ARYbPK9Ub18eG+ljU96qKRCWh+quCY7yefSmlkQw1ANQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script>
      function loadForChart() {
        const data = JSON.parse(localStorage.getItem('refine'));
        let groupData = _.chain(data.entities).groupBy("cluster").value();
        const nodes = [];
        const links = [];
        let sourceCounter = 1;
        let targetCounter = 1;
        let changedGroupValue = 1;
        let oldKey = "";
        let id = 0;
        Object.keys(groupData).forEach(function (item, key) {
          let groupList = groupData[item];
          groupList.forEach(function (innerGroupItem, innerKey) {
            id++;
            nodes.push({
              id: id,
              label: innerGroupItem.entity,
              group: innerGroupItem.cluster,
              size: innerGroupItem.size === 0 ? 0 : Math.log(innerGroupItem.size, 10),
            });

            if (oldKey !== "") {
              links.push({
                source: changedGroupValue,
                target: sourceCounter,
                value: 1,
              });
              targetCounter = sourceCounter;
              // sourceCounter += 1
              oldKey = "";
            }

            links.push({
              source: sourceCounter,
              target: targetCounter,
              value: 1,
            });
            sourceCounter += 1;
          });
          // storing parent loop key
          oldKey = key;
          // targetCounter = sourceCounter
          changedGroupValue = targetCounter;
        });
        links.shift();
        document.getElementById('chart1').innerHTML = null;
        const chartElement = document.getElementById('chart1')
        const divSize = chartElement.getBoundingClientRect()
        const width = divSize.width,
          height = divSize.height;

        const colors = [
          "#857c85",
          "#d27d7d",
          "#c16548",
          "#b960a7",
          "#ddbd4d",
          "#705177",
        ];

        var fisheye = d3.fisheye.circular().radius(200);

        const zoom = d3.zoom().scaleExtent([0.5, 2]).on("zoom", zoomed);

        function zoomed() {
          node.attr("transform", d3.event.transform);
          link.attr("transform", d3.event.transform);
          text.attr("transform", d3.event.transform);
        }

        var svg = d3
            .select("#chart1")
            .append("svg")
            .attr("width", width)
            .attr("height", height + 50),
          transform = d3.zoomIdentity;

        // custom color range
        // var color = d3.scaleOrdinal(d3.schemeCategory20).range(colors);

        // default d3 color range
        const color = d3.scaleOrdinal(d3.schemeCategory20)
        svg.call(zoom);

        d3.select("#zoomIN").on("click", () => {
          zoom.scaleBy(svg.transition().duration(750), 1.2);
        });

        d3.select("#zoonOut").on("click", () => {
          zoom.scaleBy(svg.transition().duration(750), 0.8);
        });

        var simulation = d3
          .forceSimulation()
          .force(
            "link",
            d3.forceLink().id(function (d) {
              return d.id;
            }).distance(15).strength(0.13)
          )
          .force("charge", d3.forceManyBody())
          .force("center", d3.forceCenter(width / 2, height / 2));

        simulation.nodes(nodes).on("tick", ticked);

        simulation.force("link").links(links);

        const tooltip = d3
          .select("#tooltip")
          .style("opacity", 0)
          .style("color", "#000");

        var link = svg
          .append("g")
          .attr("class", "links")
          .selectAll("line")
          .data(links)
          .enter()
          .append("line")
          .attr("stroke-width", function (d) {
            return Math.sqrt(d.value);
          });

        const nodeGroup = svg.append("g").attr("class", "nodes").selectAll("node");

        const singlNodeGroup = svg
          .selectAll(".node")
          .data(nodes)
          .enter()
          .append("g")
          // .attr("transform", (d) => "translate(" + d.x + "," + d.y + ")")

        var node = singlNodeGroup
          .append("circle")
          .classed("node", true)
          .attr("r", 5)
          .attr("cx", function (d) {
            return d.x;
          })
          .attr("cy", function (d) {
            return d.y;
          })
          .attr("fill", function (d) {
            return color(d.group);
          })
          .call(
            d3
              .drag()
              .on("start", dragstarted)
              .on("drag", dragged)
              .on("end", dragended)
          )
          .on("mouseover", (d) => {
            tooltip.transition().duration(200).style("opacity", 0.9);
            tooltip
              .html(d.label)
              .style("left", `${d3.event.layerX + 20}px`)
              .style("top", `${d3.event.layerY}px`)
              .style("width", "fit-content");
            tooltip.style("background-color", color(d.group));
          })
          .on("mouseout", function (d) {
            tooltip.transition().duration(200).style("opacity", 0);
          });

        var text = singlNodeGroup
          .append("text")
          .attr("class", "text")
          .attr("y", function(d) {
            return d.y;
          })
          .attr("x", function(d) {
            return d.x + 10;
          })
          .text(function(d) {
            return d.label;
          });

        function ticked() {
          link
            .attr("x1", function (d) {
              return d.source.x;
            })
            .attr("y1", function (d) {
              return d.source.y;
            })
            .attr("x2", function (d) {
              return d.target.x;
            })
            .attr("y2", function (d) {
              return d.target.y;
            });

          node
            .attr("cx", function (d) {
              return d.x;
            })
            .attr("cy", function (d) {
              return d.y;
            });

          text.attr("x", function (d) {
              return d.x + 10;
            })
            .attr("y", function (d) {
              return d.y + 5;
            });
        }

        svg.on("mousemove", function () {
          fisheye.focus(d3.mouse(this));
          node
            .each(function (d) {
              d.fisheye = fisheye(d);
            })
            .attr("cx", function (d) {
              return d.fisheye.x;
            })
            .attr("cy", function (d) {
              return d.fisheye.y;
            })
            .attr("r", function (d) {
              return d.fisheye.z * 4.5;
            });

          link
            .attr("x1", function (d) {
              return d.source.fisheye.x;
            })
            .attr("y1", function (d) {
              return d.source.fisheye.y;
            })
            .attr("x2", function (d) {
              return d.target.fisheye.x;
            })
            .attr("y2", function (d) {
              return d.target.fisheye.y;
            });

          singlNodeGroup
            .select("text")
            .attr("x", (d) => {
                return d.fisheye.x + 10;
            })
            .attr("y", function(d) {
                return d.fisheye.y + 2;
            });
        });

        function dragstarted(d) {
          if (!d3.event.active) simulation.alphaTarget(0.3).restart();
          d.fx = d.x;
          d.fy = d.y;
        }

        function dragged(d) {
          d.fx = d3.event.x;
          d.fy = d3.event.y;
        }

        function dragended(d) {
          if (!d3.event.active) simulation.alphaTarget(0);
          d.fx = d.x;
          d.fy = d.y;
        }
      }

      function redraw() {
        window.location.reload()
      }
    </script>
  </body>
</html>
